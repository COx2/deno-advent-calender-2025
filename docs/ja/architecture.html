<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>アーキテクチャ - Deno C++ Project Generator</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>
<body>
    <header class="page-header">
        <div class="container">
            <h1>アーキテクチャ</h1>
            <p>ジェネレータとビルドシステムの技術的な解説</p>
        </div>
    </header>

    <nav class="navbar">
        <div class="container">
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="usage.html">Usage</a></li>
                <li><a href="architecture.html" class="active">Architecture</a></li>
                <li class="lang-switcher"><a href="../en/architecture.html">EN</a></li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <section id="overview">
            <h2>システム概要</h2>

            <div class="architecture-diagram">
                <svg viewBox="0 0 700 420" xmlns="http://www.w3.org/2000/svg" style="max-width: 700px; width: 100%;">
                    <style>
                        .box { fill: none; stroke: #70c0ba; stroke-width: 2; }
                        .box-inner { fill: none; stroke: #4a9a94; stroke-width: 1.5; }
                        .box-nested { fill: none; stroke: #666; stroke-width: 1; }
                        .text-title { fill: #b5cea8; font-family: 'Fira Code', monospace; font-size: 14px; font-weight: bold; }
                        .text-label { fill: #b5cea8; font-family: 'Fira Code', monospace; font-size: 11px; }
                        .text-small { fill: #888; font-family: 'Fira Code', monospace; font-size: 9px; }
                        .arrow { stroke: #70c0ba; stroke-width: 2; fill: none; }
                        .arrow-head { fill: #70c0ba; }
                    </style>

                    <!-- Outer box: Deno Runtime -->
                    <rect x="10" y="10" width="680" height="400" rx="5" class="box"/>
                    <text x="350" y="35" text-anchor="middle" class="text-title">Deno Runtime</text>
                    <line x1="10" y1="50" x2="690" y2="50" stroke="#70c0ba" stroke-width="2"/>

                    <!-- Top row: generate.ts -> templates.ts -> Project Files -->
                    <rect x="40" y="70" width="120" height="50" rx="3" class="box-inner"/>
                    <text x="100" y="92" text-anchor="middle" class="text-label">generate.ts</text>
                    <text x="100" y="107" text-anchor="middle" class="text-small">(Entry)</text>

                    <rect x="220" y="70" width="120" height="50" rx="3" class="box-inner"/>
                    <text x="280" y="92" text-anchor="middle" class="text-label">templates.ts</text>
                    <text x="280" y="107" text-anchor="middle" class="text-small">(Templates)</text>

                    <rect x="400" y="70" width="120" height="50" rx="3" class="box-inner"/>
                    <text x="460" y="92" text-anchor="middle" class="text-label">Project</text>
                    <text x="460" y="107" text-anchor="middle" class="text-small">Files</text>

                    <!-- Arrows between top boxes -->
                    <line x1="160" y1="95" x2="215" y2="95" class="arrow"/>
                    <polygon points="220,95 210,90 210,100" class="arrow-head"/>

                    <line x1="340" y1="95" x2="395" y2="95" class="arrow"/>
                    <polygon points="400,95 390,90 390,100" class="arrow-head"/>

                    <!-- Arrow down from generate.ts -->
                    <line x1="100" y1="120" x2="100" y2="155" class="arrow"/>
                    <polygon points="100,160 95,150 105,150" class="arrow-head"/>

                    <!-- Generated Project box -->
                    <rect x="40" y="160" width="620" height="230" rx="5" class="box-inner"/>
                    <text x="350" y="185" text-anchor="middle" class="text-title">Generated Project</text>

                    <!-- Inner boxes: build.ts, cmake-file-api.ts, cmake-types.ts -->
                    <rect x="60" y="200" width="110" height="50" rx="3" class="box-nested"/>
                    <text x="115" y="230" text-anchor="middle" class="text-label">build.ts</text>

                    <rect x="190" y="200" width="130" height="50" rx="3" class="box-nested"/>
                    <text x="255" y="222" text-anchor="middle" class="text-label">cmake-</text>
                    <text x="255" y="237" text-anchor="middle" class="text-label">file-api.ts</text>

                    <rect x="340" y="200" width="110" height="50" rx="3" class="box-nested"/>
                    <text x="395" y="222" text-anchor="middle" class="text-label">cmake-</text>
                    <text x="395" y="237" text-anchor="middle" class="text-label">types.ts</text>

                    <!-- Arrows down to CMake -->
                    <line x1="115" y1="250" x2="115" y2="285" class="arrow"/>
                    <polygon points="115,290 110,280 120,280" class="arrow-head"/>

                    <line x1="255" y1="250" x2="255" y2="285" class="arrow"/>
                    <polygon points="255,290 250,280 260,280" class="arrow-head"/>

                    <!-- CMake box -->
                    <rect x="60" y="290" width="320" height="85" rx="3" class="box-nested"/>
                    <text x="220" y="315" text-anchor="middle" class="text-label">CMake</text>

                    <!-- File API v1 box inside CMake -->
                    <rect x="80" y="325" width="280" height="35" rx="3" class="box-nested"/>
                    <text x="220" y="348" text-anchor="middle" class="text-label">File API v1</text>
                </svg>
            </div>
        </section>

        <section id="generator">
            <h2>ジェネレータアーキテクチャ</h2>

            <h3>generate.ts - エントリーポイント</h3>
            <p>ジェネレータのメインファイルです。コマンドライン引数を解析し、プロジェクト生成を制御します。</p>

            <pre><code class="language-typescript">// コマンドライン引数の解析
const args = parseArgs(Deno.args, {
  boolean: ["help", "with-git"],
  string: ["name", "author", "version", "output"],
  default: {
    name: "MyApp",
    author: "Your Name",
    version: "1.0.0",
  },
});

// プロジェクト設定の構築
const config: ProjectConfig = {
  name: projectName,
  nameLower: toSnakeCase(projectName),
  nameUpper: nameLower.toUpperCase(),
  author: args.author,
  version: args.version,
  outputDir: args.output || projectName.toLowerCase(),
  withGit: args["with-git"],
};</code></pre>

            <h3>templates.ts - テンプレート生成</h3>
            <p>各ファイルのテンプレートを生成する関数群です。プロジェクト設定に基づいて動的にコンテンツを生成します。</p>

            <pre><code class="language-typescript">// CMakeLists.txt の生成例
export function generateCMakeLists(config: ProjectConfig): string {
  return `cmake_minimum_required(VERSION 3.15)
project(${config.name} VERSION ${config.version} LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 17)
...
`;
}</code></pre>

            <h3>Deno URL実行の仕組み</h3>
            <p>
                Denoは <code>deno run &lt;url&gt;</code> でリモートのTypeScriptを直接実行できます。
                これにより、ユーザーはツールをインストールせずにジェネレータを使用できます。
            </p>

            <div class="flow-diagram">
                <div class="flow-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h4>URL指定で実行</h4>
                        <code>deno run https://...generate.ts</code>
                    </div>
                </div>
                <div class="flow-arrow">→</div>
                <div class="flow-step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h4>自動ダウンロード</h4>
                        <p>Denoがスクリプトと依存関係をダウンロード</p>
                    </div>
                </div>
                <div class="flow-arrow">→</div>
                <div class="flow-step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h4>ローカル実行</h4>
                        <p>ローカルファイルシステムにプロジェクト生成</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="build-system">
            <h2>ビルドシステムアーキテクチャ</h2>

            <h3>build.ts - ビルドスクリプト</h3>
            <p>Denoとdaxを使用したクロスプラットフォームビルドスクリプトです。</p>

            <pre><code class="language-typescript">import $ from "jsr:@david/dax@0.42.0";

// CMake設定
async function configure(): Promise&lt;void&gt; {
  await $`mkdir -p build`;
  await setupFileAPI("build");
  await $`cmake -B build -DCMAKE_BUILD_TYPE=${args.config}`;
}

// ビルド実行
async function build(): Promise&lt;BuildArtifact[]&gt; {
  await $`cmake --build build --config ${args.config}`;
  const artifacts = await parseFileAPI("build");
  return artifacts;
}</code></pre>

            <h3>dax の特徴</h3>
            <ul class="feature-list">
                <li>
                    <strong>クロスプラットフォーム</strong>
                    - <code>$`mkdir -p`</code> がWindowsでも動作
                </li>
                <li>
                    <strong>テンプレートリテラル</strong>
                    - 変数の安全な埋め込み
                </li>
                <li>
                    <strong>エラーハンドリング</strong>
                    - コマンド失敗時の自動例外スロー
                </li>
                <li>
                    <strong>パイプ・リダイレクト</strong>
                    - シェルライクな操作が可能
                </li>
            </ul>
        </section>

        <section id="cmake-file-api">
            <h2>CMake File API連携</h2>

            <p>
                CMake File API v1 を使用して、ビルド成果物の情報をプログラマティックに取得します。
                これにより、ハードコードされたパスに依存せず、プラットフォームやジェネレータに応じた
                正しいパスを自動検出できます。
            </p>

            <h3>仕組み</h3>
            <div class="api-flow">
                <div class="api-step">
                    <h4>1. Query作成</h4>
                    <p><code>build/.cmake/api/v1/query/codemodel-v2</code> に空ファイルを作成</p>
                </div>
                <div class="api-step">
                    <h4>2. CMake実行</h4>
                    <p>CMake設定時にQueryを検出し、Replyを生成</p>
                </div>
                <div class="api-step">
                    <h4>3. Reply解析</h4>
                    <p><code>build/.cmake/api/v1/reply/</code> のJSONファイルをパース</p>
                </div>
            </div>

            <h3>Reply構造</h3>
            <pre><code class="language-typescript">// cmake-types.ts より
interface FileAPIIndex {
  cmake: { version: {...} };
  objects: Array&lt;{ kind: string; jsonFile: string; }&gt;;
  reply: {
    [key: string]: { kind: string; jsonFile: string; };
  };
}

interface CodeModelV2 {
  paths: { source: string; build: string; };
  configurations: Array&lt;{
    name: string;
    targets: Array&lt;{ name: string; jsonFile: string; }&gt;;
  }&gt;;
}

interface TargetInfo {
  name: string;
  type: "EXECUTABLE" | "STATIC_LIBRARY" | "SHARED_LIBRARY";
  artifacts?: Array&lt;{ path: string; }&gt;;
}</code></pre>

            <h3>利点</h3>
            <ul>
                <li>Visual Studio / Unix Makefiles / Ninja など、どのジェネレータでも動作</li>
                <li>Debug / Release などのビルドタイプを自動認識</li>
                <li>生成されたすべてのターゲット（実行ファイル、ライブラリ）を自動検出</li>
            </ul>
        </section>

        <section id="cpp-structure">
            <h2>C++プロジェクト構造</h2>

            <h3>ターゲット構成</h3>
            <div class="cpp-targets">
                <div class="cpp-target">
                    <h4>静的ライブラリ: [project]_core</h4>
                    <pre><code class="language-cmake">add_library(myapp_core STATIC
    src/core/core.cpp
    src/core/core.h
)</code></pre>
                    <p>内部リンク用の静的ライブラリ。バイナリに直接リンクされます。</p>
                </div>

                <div class="cpp-target">
                    <h4>共有ライブラリ: [project]_utils</h4>
                    <pre><code class="language-cmake">add_library(myapp_utils SHARED
    src/utils/utils.cpp
    src/utils/utils.h
)
target_compile_definitions(myapp_utils
    PRIVATE MYAPP_UTILS_EXPORTS)</code></pre>
                    <p>動的リンクライブラリ。Windows DLLエクスポートマクロを含みます。</p>
                </div>

                <div class="cpp-target">
                    <h4>実行ファイル: [project]</h4>
                    <pre><code class="language-cmake">add_executable(myapp src/main.cpp)
target_link_libraries(myapp PRIVATE
    myapp_core
    myapp_utils
)</code></pre>
                    <p>両方のライブラリを使用するメインアプリケーション。</p>
                </div>
            </div>

            <h3>Windows DLLエクスポート</h3>
            <p>Windows環境では、共有ライブラリのシンボルを適切にエクスポート/インポートする必要があります：</p>

            <pre><code class="language-cpp">// utils.h
#ifdef _WIN32
    #ifdef MYAPP_UTILS_EXPORTS
        #define MYAPP_UTILS_API __declspec(dllexport)
    #else
        #define MYAPP_UTILS_API __declspec(dllimport)
    #endif
#else
    #define MYAPP_UTILS_API
#endif

MYAPP_UTILS_API void myFunction();</code></pre>
        </section>

        <section id="dependencies">
            <h2>依存関係</h2>

            <table class="deps-table">
                <thead>
                    <tr>
                        <th>パッケージ</th>
                        <th>バージョン</th>
                        <th>用途</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><a href="https://jsr.io/@david/dax">@david/dax</a></td>
                        <td>0.42.0</td>
                        <td>クロスプラットフォームシェルコマンド実行</td>
                    </tr>
                    <tr>
                        <td><a href="https://jsr.io/@std/cli">@std/cli</a></td>
                        <td>1.0.6</td>
                        <td>コマンドライン引数解析</td>
                    </tr>
                    <tr>
                        <td><a href="https://jsr.io/@std/path">@std/path</a></td>
                        <td>1.0.8</td>
                        <td>パス操作</td>
                    </tr>
                    <tr>
                        <td><a href="https://jsr.io/@std/fs">@std/fs</a></td>
                        <td>1.0.8</td>
                        <td>ファイルシステム操作</td>
                    </tr>
                </tbody>
            </table>

            <p>
                すべての依存関係は <a href="https://jsr.io/">JSR (JavaScript Registry)</a> から取得されます。
                Denoは実行時に自動的にダウンロード・キャッシュします。
            </p>
        </section>

        <section id="security">
            <h2>セキュリティモデル</h2>

            <p>Denoはデフォルトでセキュアです。ジェネレータは必要最小限の権限のみを要求します：</p>

            <table class="permissions-table">
                <thead>
                    <tr>
                        <th>権限</th>
                        <th>フラグ</th>
                        <th>用途</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>ファイル読み取り</td>
                        <td><code>--allow-read</code></td>
                        <td>既存ディレクトリの確認</td>
                    </tr>
                    <tr>
                        <td>ファイル書き込み</td>
                        <td><code>--allow-write</code></td>
                        <td>プロジェクトファイルの生成</td>
                    </tr>
                    <tr>
                        <td>コマンド実行</td>
                        <td><code>--allow-run</code></td>
                        <td>git init の実行（オプション）</td>
                    </tr>
                </tbody>
            </table>

            <div class="note">
                <strong>Note:</strong>
                生成されたプロジェクトの <code>build.ts</code> は <code>--allow-all</code> を使用します。
                これはCMakeやコンパイラの実行に必要な権限を包括的に付与するためです。
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>
                Created for <a href="https://qiita.com/advent-calendar/2025/deno">Deno Advent Calendar 2025</a>
            </p>
            <p>
                <a href="https://github.com/COx2/deno-advent-calender-2025">GitHub Repository</a> |
                MIT License
            </p>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-cmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-cpp.min.js"></script>
</body>
</html>
